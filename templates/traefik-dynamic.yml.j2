# Auto-generated Traefik dynamic configuration
# Domain: {{ domain }}
# Generated: {{ generated_date }}

http:
  routers:
{% if services.orangescrum_v4 or services.orangescrum or services.durango_pg %}
    # Root domain redirect to primary application
    root-redirect:
      rule: "Host(`{{ domain }}`)"
      middlewares:
        - redirect-root
      entryPoints:
        - {% if enable_https %}websecure{% else %}web{% endif %}
{% if enable_https %}
      tls: {}
{% endif %}
      priority: 150
      service: noop@internal
{% endif %}

{% if services.durango_pg %}
    # Durango PG - selfhosted subdomain
    durango-pg:
      rule: "Host(`selfhosted.{{ domain }}`)"
      service: durango-pg
      entryPoints:
        - {% if enable_https %}websecure{% else %}web{% endif %}
{% if enable_https %}
      tls: {}
{% endif %}
      priority: 100
{% endif %}

{% if services.orangescrum_v4 %}
    # OrangeScrum V4 - v4 subdomain
    orangescrum-v4:
      rule: "Host(`v4.{{ domain }}`)"
      service: orangescrum-v4
      entryPoints:
        - {% if enable_https %}websecure{% else %}web{% endif %}
{% if enable_https %}
      tls: {}
{% endif %}
      priority: 100
{% endif %}

{% if services.orangescrum %}
    # OrangeScrum V2 - app subdomain (and www)
    orangescrum:
      rule: "Host(`app.{{ domain }}`, `www.{{ domain }}`)"
      service: orangescrum
      entryPoints:
        - {% if enable_https %}websecure{% else %}web{% endif %}
{% if enable_https %}
      tls: {}
{% endif %}
      priority: 100
{% endif %}

{% if services.mailhog %}
    # MailHog
    mailhog:
      rule: "Host(`mail.{{ domain }}`)"
      service: mailhog
      entryPoints:
        - {% if enable_https %}websecure{% else %}web{% endif %}
{% if enable_https %}
      tls: {}
{% endif %}
      priority: 100
{% endif %}

    # Traefik Dashboard
    traefik-dashboard:
      rule: "Host(`traefik.{{ domain }}`)"
      service: api@internal
      entryPoints:
        - {% if enable_https %}websecure{% else %}web{% endif %}
{% if enable_https %}
      tls: {}
{% endif %}
      priority: 100

  middlewares:
{% if services.orangescrum_v4 or services.orangescrum or services.durango_pg %}
    redirect-root:
      redirectRegex:
        regex: "^{{ 'https' if enable_https else 'http' }}://{{ domain }}/(.*)"
        replacement: "{{ 'https' if enable_https else 'http' }}://{% if services.orangescrum_v4 %}v4{% elif services.durango_pg %}selfhosted{% elif services.orangescrum %}app{% else %}traefik{% endif %}.{{ domain }}/${1}"
        permanent: true
{% endif %}

  services:
{% if services.durango_pg %}
    durango-pg:
      loadBalancer:
        servers:
          - url: "http://durango-pg:80"
{% endif %}

{% if services.orangescrum_v4 %}
    orangescrum-v4:
      loadBalancer:
        servers:
          - url: "http://orangescrum-v4:80"
{% endif %}

{% if services.orangescrum %}
    orangescrum:
      loadBalancer:
        servers:
          - url: "http://orangescrum:80"
{% endif %}

{% if services.mailhog %}
    mailhog:
      loadBalancer:
        servers:
          - url: "http://mailhog:8025"
{% endif %}

{% if enable_https %}
tls:
  certificates:
    - certFile: /certs/{{ domain }}.crt
      keyFile: /certs/{{ domain }}.key
  stores:
    default:
      defaultCertificate:
        certFile: /certs/{{ domain }}.crt
        keyFile: /certs/{{ domain }}.key
{% endif %}
