# PHP 8.3 + Node.js Environment for OrangeScrum with Vue.js
# Based on common Ubuntu base
# Includes Node.js {{ node_version | default('20.x') }} for Vue development and builds
# Generated: {{ generation_date }}

ARG BASE_IMAGE=orangescrum-base:{{ domain | replace('.', '-') }}
FROM ${BASE_IMAGE}

# Install PHP 8.3 and required extensions
RUN apt update && \
    apt install -y --no-install-recommends \
        libapache2-mod-php8.3 \
        php8.3 \
        php8.3-cli \
        php8.3-common \
        php8.3-mbstring \
        php8.3-xml \
        php8.3-mysql \
        php8.3-pgsql \
        php8.3-intl \
        php8.3-zip \
        php8.3-curl \
        php8.3-gd \
        php8.3-memcached \
        php8.3-redis \
        php8.3-soap \
        php8.3-bcmath \
        php8.3-sqlite3 \
        php8.3-opcache && \
    apt clean && rm -rf /var/lib/apt/lists/*

# Install Node.js and npm
ARG NODE_VERSION={{ node_version | default('20.x') }}
RUN curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION} | bash - && \
    apt update && \
    apt install -y --no-install-recommends nodejs && \
    apt clean && rm -rf /var/lib/apt/lists/*

# Install common Node.js build tools
RUN npm install -g npm@latest && \
    npm install -g yarn pnpm

# Install Composer (latest version)
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

# Copy certificate trust script
COPY php-trust-certs.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/php-trust-certs.sh

# Copy entrypoint scripts
COPY entrypoints/orangescrum-v4.sh /usr/local/bin/ 2>/dev/null || true
RUN [ -f /usr/local/bin/orangescrum-v4.sh ] && chmod +x /usr/local/bin/orangescrum-v4.sh || true

# Set PHP version for CLI
RUN update-alternatives --set php /usr/bin/php8.3

WORKDIR /var/www/html

CMD ["sh", "-c", "/usr/local/bin/php-trust-certs.sh && apache2ctl -D FOREGROUND"]
