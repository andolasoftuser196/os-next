# FrankenPHP Deployment Organization - Clean Separation

## Overview

The FrankenPHP deployment is organized to **eliminate file duplication** while maintaining clear separation between Docker and Native deployments.

**Key Principle:** Common files live in `orangescrum-cloud-common/`, deployment-specific files in their respective sources, and final packages are **built on demand** by `build.py`.

## Current Structure

```
cloud-builder/
├── orangescrum-cloud/              # Source build scripts
│   ├── build-docker.sh             # Build Docker deployment
│   ├── build-native.sh             # Build Native deployment
│   ├── dist-docker.sh              # Create Docker distribution tarball
│   ├── dist-native.sh              # Create Native distribution tarball
│   ├── Dockerfile                  # Docker-specific
│   ├── docker-compose.yaml         # Docker-specific
│   ├── entrypoint.sh               # Docker-specific
│   ├── run.sh                      # Native-specific
│   ├── package.sh                  # Native-specific
│   └── ...helper scripts...
│
├── orangescrum-cloud-common/       # SOURCE OF TRUTH (shared files)
│   ├── orangescrum-app/
│   │   └── osv4-prod               # Binary (built by build.py)
│   ├── config/                     # Common configs
│   ├── docs/                       # Common docs
│   ├── helpers/                    # Common helper scripts
│   ├── .env.example                # Base environment template
│   └── CONFIGS.md                  # Configuration documentation
│
├── orangescrum-cloud-docker/       # Docker deployment source
│   ├── build.sh                    # Assembles dist-docker/ package
│   ├── Dockerfile                  # Docker-specific (copied from orangescrum-cloud/)
│   ├── docker-compose.yaml         # Docker orchestration (copied)
│   ├── entrypoint.sh               # Docker entrypoint (copied)
│   ├── config/                     # Copied from common
│   ├── docs/                       # Copied from common
│   ├── helpers/                    # Copied from common
│   └── orangescrum-app/osv4-prod  # Copied from common
│
├── orangescrum-cloud-native/       # Native deployment source
│   ├── build.sh                    # Assembles dist-native/ package
│   ├── run.sh                     # Native runner
│   ├── package.sh                  # Native-specific (copied)
│   ├── config/                     # Copied from common
│   ├── docs/                       # Copied from common
│   ├── helpers/                    # Copied from common
│   └── orangescrum-app/osv4-prod  # Copied from common
│
├── dist-docker/                    # AUTO-GENERATED (by build.py)
│   └── [Ready-to-deploy Docker package]
│
└── dist-native/                    # AUTO-GENERATED (by build.py)
    └── [Ready-to-deploy Native package]
```

## How It Works

### 1. Build Process

```bash
cd cloud-builder
python3 build.py
```

**What happens:**
1. Archives OrangeScrum V4 app from `../apps/orangescrum-v4`
2. Builds FrankenPHP base image (if needed, ~30 min)
3. Embeds app into FrankenPHP binary (~2 min)
4. Extracts binary to `orangescrum-cloud-common/orangescrum-app/osv4-prod`
5. Runs `orangescrum-cloud-docker/build.sh` → Creates `dist-docker/`
6. Runs `orangescrum-cloud-native/build.sh` → Creates `dist-native/`

### 2. What Gets Built

**orangescrum-cloud-docker/build.sh** assembles:
- Docker-specific: `Dockerfile`, `docker-compose.yaml`, `entrypoint.sh`, `.dockerignore`
- Common files: `config/`, `docs/`, helper scripts from `orangescrum-cloud-common/`
- Binary: `orangescrum-app/osv4-prod` from `orangescrum-cloud-common/`
- Output: `dist-docker/`

**orangescrum-cloud-native/build.sh** assembles:
- Native-specific: `run.sh`, `package.sh`, `systemd/`
- Common files: `config/`, `docs/`, helper scripts from `orangescrum-cloud-common/`
- Binary: `orangescrum-app/osv4-prod` from `orangescrum-cloud-common/`
- Output: `dist-native/`

## No More Duplication!

### Before (Problem)
```
- config/ existed in 3+ places
- docs/ existed in 3+ places  
- Helper scripts duplicated everywhere
- Confusing which is the "source"
- Binary duplicated in multiple locations
```

### After (Solution)
```
- config/ in orangescrum-cloud-common/ only
- docs/ in orangescrum-cloud-common/ only
- Helper scripts in orangescrum-cloud-common/helpers/ only
- Binary in orangescrum-cloud-common/orangescrum-app/ only
- Clear: orangescrum-cloud-common/ is the source
- Deployment packages are auto-generated by build.py
- Source assembly scripts in orangescrum-cloud-docker/ and orangescrum-cloud-native/
```

## Making Changes

### Updating Common Files (config, docs, scripts)

**Edit in source folder:**
```bash
cd orangescrum-cloud-common/
nano config/cache_redis.example.php  # Make your changes
nano docs/PRODUCTION_DEPLOYMENT_DOCKER.md  # Update docs
nano helpers/cake.sh  # Update helper
```

**Rebuild deployment packages:**
```bash
# Rebuild both packages
cd ../orangescrum-cloud-docker
./build.sh

cd ../orangescrum-cloud-native
./build.sh

# Or use build.py with skip flags
cd ..
python3 build.py --skip-archive --skip-base
```

### Updating Docker-Specific Files

**Edit in source folder:**
```bash
cd orangescrum-cloud/
nano Dockerfile
nano docker-compose.yaml
nano entrypoint.sh
```

**Rebuild:**
```bash
cd ../orangescrum-cloud-docker
./build.sh
```

### Updating Native-Specific Files

**Edit in source folder:**
```bash
cd orangescrum-cloud/
nano run.sh
nano package.sh
```

**Rebuild:**
```bash
cd ../orangescrum-cloud-native
./build.sh
```

### Updating Application Code

**Edit application:**
```bash
cd ../apps/orangescrum-v4
# Make your code changes
```

**Rebuild everything:**
```bash
cd ../cloud-builder
python3 build.py
# This rebuilds binary + both deployment packages
```
- `validate-env.sh` - Environment validator
- `.env.example` - Environment template
- `CONFIGS.md` - Configuration reference

**Docker-Specific** (copied to docker deployment):
- `Dockerfile`
- `docker-compose.yaml`
- `docker-compose.services.yml`
- `entrypoint.sh`
- `.dockerignore`
- `.env.docker`

**Native-Specific** (copied to native deployment):
- `run.sh`
- `run.sh`
- `package.sh`
## Deployment Workflow

### Full Build (First Time)

```bash
# Build everything from scratch
cd cloud-builder
python3 build.py

# This automatically:
# 1. Builds the FrankenPHP binary
# 2. Runs orangescrum-cloud-docker/build.sh → dist-docker/
# 3. Runs orangescrum-cloud-native/build.sh → dist-native/
```

### Rebuild Binary Only

```bash
# Update application code
cd ../apps/orangescrum-v4
# Make changes...

# Rebuild binary
cd ../cloud-builder
python3 build.py
```

### Rebuild Deployment Packages Only

If you've updated common files but haven't changed the binary:

```bash
cd cloud-builder/orangescrum-cloud-docker
./build.sh

cd ../orangescrum-cloud-native
./build.sh
```

### Deploy Docker Package

```bash
cd dist-docker/
cp .env.example .env
nano .env  # Configure DB, security, etc

# Start infrastructure services (optional)
docker-compose -f docker-compose.services.yml up -d

# Start application
docker compose up -d

# View logs
docker compose logs -f orangescrum-app
```

### Deploy Native Package

```bash
cd dist-native/
cp .env.example .env
nano .env  # Configure DB, security, etc

# Validate configuration
./validate-env.sh

# Run application
./run.sh

# Or run as daemon
DAEMON=true ./run.sh &
```

## Benefits

### No Duplication
- Files exist in one place only (`orangescrum-cloud-common/`)
- Updates propagate to all deployment packages
- Smaller repository size

### Clear Organization
- Source files in appropriate folders
- Generated packages in `dist-*/`
- Easy to understand what to edit

### Automated Building
- `python3 build.py` builds everything
- Build scripts ensure consistency
- No manual file copying

### Easy Maintenance
- Edit source once, rebuild packages
- Version control tracks source only
- Clear separation of concerns

## Quick Reference

| Task | Command |
|------|---------|
| Full build | `python3 build.py` |
| Rebuild Docker package | `cd orangescrum-cloud-docker && ./build.sh` |
| Rebuild Native package | `cd orangescrum-cloud-native && ./build.sh` |
| Edit common files | Edit in `orangescrum-cloud-common/`, rebuild packages |
| Edit Docker-specific | Edit in `orangescrum-cloud/`, run Docker build.sh |
| Edit Native-specific | Edit in `orangescrum-cloud/`, run Native build.sh |
| Deploy Docker | `cd dist-docker && docker compose up -d` |
| Deploy Native | `cd dist-native && ./run.sh` |
| Create distribution tarball | `cd orangescrum-cloud && ./dist-docker.sh` or `./dist-native.sh` |

---

**Remember:** 
- `orangescrum-cloud-common/` = Shared files (config, docs, binary)
- `orangescrum-cloud/` = Build orchestration scripts
- `orangescrum-cloud-docker/` & `orangescrum-cloud-native/` = Source assembly scripts
- `dist-docker/` & `dist-native/` = Auto-generated deployment packages


