#!/usr/bin/env python3
"""Build and deploy multi-application Docker stack.

This script:
1) Generates docker-compose.yml from templates with specified domain
2) Generates SSL certificates for the domain
3) Builds PHP container images (PHP 7.2 and PHP 8.3)
4) Initializes PostgreSQL and MySQL databases
5) Starts all services with Traefik reverse proxy

Supports three applications:
- Durango PG (PHP 8.3 + PostgreSQL)
- OrangeScrum V4 (PHP 8.3 + PostgreSQL)
- OrangeScrum V2 (PHP 7.2 + MySQL)
"""

from __future__ import annotations

import argparse
import os
import shutil
import subprocess
import sys
from pathlib import Path

# Paths
ROOT = Path(__file__).parent.parent.resolve()
CLOUD_BUILDER = Path(__file__).parent.resolve()
TEMPLATES_DIR = ROOT / "templates"
VENV_DIR = ROOT / ".venv"

# Template files
DOCKER_COMPOSE_TEMPLATE = TEMPLATES_DIR / "docker-compose.yml.j2"
TRAEFIK_DYNAMIC_TEMPLATE = TEMPLATES_DIR / "traefik-dynamic.yml.j2"
APACHE_DURANGO_TEMPLATE = TEMPLATES_DIR / "durango-apache.conf.j2"
APACHE_ORANGESCRUM_TEMPLATE = TEMPLATES_DIR / "orangescrum-apache.conf.j2"
GENERATE_CERTS_TEMPLATE = TEMPLATES_DIR / "generate-certs.sh.j2"
PHP_TRUST_CERTS_TEMPLATE = TEMPLATES_DIR / "php-trust-certs.sh.j2"

# Output files
DOCKER_COMPOSE_FILE = ROOT / "docker-compose.yml"
TRAEFIK_DYNAMIC_FILE = ROOT / "traefik/dynamic.yml"
APACHE_DURANGO_FILE = ROOT / "config/durango-apache.conf"
APACHE_ORANGESCRUM_FILE = ROOT / "config/orangescrum-apache.conf"
GENERATE_CERTS_FILE = ROOT / "generate-certs.sh"
PHP_TRUST_CERTS_FILE = ROOT / "php-trust-certs.sh"


def _run_cmd(
    cmd: list[str], cwd: Path | None = None, env: dict[str, str] | None = None
):
    print(f"Running: {' '.join(cmd)}")
    subprocess.check_call(cmd, cwd=str(cwd) if cwd else None, env=env)


def _run_cmd_capture(
    cmd: list[str], cwd: Path | None = None, env: dict[str, str] | None = None
) -> str:
    print(f"Running: {' '.join(cmd)}")
    return subprocess.check_output(
        cmd, cwd=str(cwd) if cwd else None, env=env, text=True
    ).strip()


def _clean_dir(path: Path):
    if path.exists():
        shutil.rmtree(path)
    path.mkdir(parents=True, exist_ok=True)


def _copy_config_overrides():
    """Copy modified config files from orangescrum-ee/config to package/config"""
    if not CONFIG_OVERRIDES_DIR.exists():
        print(f"Warning: Config overrides directory not found: {CONFIG_OVERRIDES_DIR}")
        return
    
    package_config = PACKAGE / "config"
    if not package_config.exists():
        print(f"Warning: Package config directory not found: {package_config}")
        return
    
    config_files = list(CONFIG_OVERRIDES_DIR.glob("*.example.php"))
    if not config_files:
        print(f"No config override files found in {CONFIG_OVERRIDES_DIR}")
        return
    
    print(f"Copying {len(config_files)} config override files...")
    for config_file in config_files:
        dest = package_config / config_file.name
        shutil.copy2(config_file, dest)
        print(f"  ✓ Copied {config_file.name}")


def _archive_repo() -> Path:
    print("Archiving OrangeScrum repo...")
    archive_path = BUILDER / "repo.tar"
    _run_cmd(
        [
            "git",
            "-C",
            str(REPO),
            "archive",
            "--format=tar",
            "HEAD",
            "-o",
            str(archive_path),
        ]
    )
    return archive_path


def _extract_archive(archive_path: Path, dest: Path):
    print("Extracting archive...")
    with tarfile.open(archive_path, "r") as tar:
        tar.extractall(path=dest)


def _ensure_base_image(docker_client: docker.DockerClient, rebuild: bool):
    if rebuild:
        try:
            docker_client.images.remove(FRANKENPHP_BASE_IMAGE, force=True)
            print(f"Removed existing base image: {FRANKENPHP_BASE_IMAGE}")
        except docker.errors.ImageNotFound:
            pass

    print(f"Checking for base image {FRANKENPHP_BASE_IMAGE}...")
    try:
        docker_client.images.get(FRANKENPHP_BASE_IMAGE)
        print("Base image found; skipping base build.")
        return
    except docker.errors.ImageNotFound:
        pass

    print("Base image not found; building base FrankenPHP image (slow)...")
    _run_cmd(
        [
            "docker",
            "compose",
            "-f",
            str(BUILDER_COMPOSE_FILE),
            "--profile",
            "base-build",
            "build",
            "frankenphp-base-builder",
        ],
        cwd=BUILDER,
    )


def _build_app_embed():
    print("Embedding application into FrankenPHP (fast)...")
    env = os.environ.copy()
    env["BUILD_DATE"] = str(int(time.time()))
    env.setdefault("FRANKENPHP_BASE_IMAGE", FRANKENPHP_BASE_IMAGE)
    _run_cmd(
        [
            "docker",
            "compose",
            "-f",
            str(BUILDER_COMPOSE_FILE),
            "build",
            "orangescrum-app-builder",
        ],
        cwd=BUILDER,
        env=env,
    )


def _start_app_builder_container():
    _run_cmd(
        [
            "docker",
            "compose",
            "-f",
            str(BUILDER_COMPOSE_FILE),
            "up",
            "-d",
            "orangescrum-app-builder",
        ],
        cwd=BUILDER,
    )


def _stop_builder_stack():
    _run_cmd(
        [
            "docker",
            "compose",
            "-f",
            str(BUILDER_COMPOSE_FILE),
            "down",
            "--remove-orphans",
        ],
        cwd=BUILDER,
    )


def _copy_frankenphp_binary(docker_client: docker.DockerClient):
    print("Copying frankenphp binary from builder container...")
    ORANGESCRUM_EE_BINARY.parent.mkdir(parents=True, exist_ok=True)

    container_id = _run_cmd_capture(
        [
            "docker",
            "compose",
            "-f",
            str(BUILDER_COMPOSE_FILE),
            "ps",
            "-q",
            "orangescrum-app-builder",
        ],
        cwd=BUILDER,
    )
    if not container_id:
        raise RuntimeError(
            "Could not find builder container id (docker compose ps -q returned empty)"
        )

    container = docker_client.containers.get(container_id)
    bits, _ = container.get_archive("/go/src/app/dist/frankenphp-linux-x86_64")

    tar_stream = io.BytesIO(b"".join(bits))
    with tarfile.open(fileobj=tar_stream) as tar:
        tar.extractall(path=ORANGESCRUM_EE_BINARY.parent)

    extracted_binary = ORANGESCRUM_EE_BINARY.parent / "frankenphp-linux-x86_64"
    if extracted_binary.exists():
        extracted_binary.rename(ORANGESCRUM_EE_BINARY)

    ORANGESCRUM_EE_BINARY.chmod(0o755)
    size_mb = ORANGESCRUM_EE_BINARY.stat().st_size / (1024 * 1024)
    print(f"Copied frankenphp to {ORANGESCRUM_EE_BINARY} ({size_mb:.1f} MB)")


def _resolve_env_file(path_str: str | None) -> Path:
    if path_str:
        return Path(path_str).expanduser().resolve()
    if APP_ENV_FILE_DEFAULT.exists():
        return APP_ENV_FILE_DEFAULT
    return APP_ENV_FILE_EXAMPLE


def _deploy_app_only(env_file: Path, env_overrides: dict[str, str]):
    print("Starting orangescrum-app (app-only compose)...")

    env = os.environ.copy()
    env["BUILD_DATE"] = str(int(time.time()))
    env.update(env_overrides)

    _run_cmd(
        [
            "docker",
            "compose",
            "-f",
            str(APP_COMPOSE_FILE),
            "--env-file",
            str(env_file),
            "up",
            "-d",
            "--build",
            "--no-deps",
            "orangescrum-app",
        ],
        cwd=ORANGESCRUM_EE_DIR,
        env=env,
    )


def _wait_for_app_healthy(
    docker_client: docker.DockerClient,
    env_overrides: dict[str, str],
    timeout_s: int = 180,
):
    print("Waiting for orangescrum-app to become healthy...")

    compose_project_name = (
        env_overrides.get("COMPOSE_PROJECT_NAME")
        or os.environ.get("COMPOSE_PROJECT_NAME")
        or "orangescrum-cloud-base"
    )
    expected_name = f"{compose_project_name}-orangescrum-app-1"

    start = time.time()
    while time.time() - start < timeout_s:
        try:
            container = docker_client.containers.get(expected_name)
        except docker.errors.NotFound:
            # Fallback: ask docker compose for the container id
            try:
                cid = _run_cmd_capture(
                    [
                        "docker",
                        "compose",
                        "-f",
                        str(APP_COMPOSE_FILE),
                        "ps",
                        "-q",
                        "orangescrum-app",
                    ],
                    cwd=ORANGESCRUM_EE_DIR,
                )
                if cid:
                    container = docker_client.containers.get(cid)
                else:
                    time.sleep(2)
                    continue
            except Exception:
                time.sleep(2)
                continue

        state = container.attrs.get("State", {})
        health = state.get("Health", {})
        status = health.get("Status") or state.get("Status")

        if status == "healthy":
            print("✓ orangescrum-app is healthy")
            return True
        if status in {"exited", "dead"}:
            logs = container.logs(tail=50).decode("utf-8", errors="ignore")
            raise RuntimeError(
                f"orangescrum-app container is not running (status={status}). Logs:\n{logs}"
            )

        time.sleep(2)

    print(f"⚠️  orangescrum-app did not become healthy within {timeout_s}s")
    return False


def check_prerequisites() -> bool:
    print("Pre-flight checks (app-only)...")

    ok = True

    # Docker daemon
    try:
        docker.from_env().ping()
        print("✓ Docker daemon is running")
    except Exception as e:
        print(f"✗ Docker daemon is not accessible: {e}")
        ok = False

    # Repo
    if REPO.exists():
        print(f"✓ OrangeScrum repository found at {REPO}")
    else:
        print(f"✗ OrangeScrum repository not found at {REPO}")
        ok = False

    # Compose files
    if BUILDER_COMPOSE_FILE.exists():
        print(f"✓ Builder compose file found at {BUILDER_COMPOSE_FILE}")
    else:
        print(f"✗ Builder compose file not found at {BUILDER_COMPOSE_FILE}")
        ok = False

    if APP_COMPOSE_FILE.exists():
        print(f"✓ App compose file found at {APP_COMPOSE_FILE}")
    else:
        print(f"✗ App compose file not found at {APP_COMPOSE_FILE}")
        ok = False

    return ok


def main():
    parser = argparse.ArgumentParser(
        description="Build and deploy ONLY the OrangeScrum app"
    )

    parser.add_argument(
        "--check", action="store_true", help="Run pre-flight checks only"
    )

    parser.add_argument(
        "--skip-archive", action="store_true", help="Skip git archive/extract step"
    )
    parser.add_argument(
        "--skip-base", action="store_true", help="Skip building base FrankenPHP image"
    )
    parser.add_argument(
        "--rebuild-base",
        action="store_true",
        help="Force rebuild base FrankenPHP image",
    )
    parser.add_argument(
        "--skip-frankenphp",
        action="store_true",
        help="Skip building/extracting FrankenPHP binary",
    )
    parser.add_argument(
        "--skip-deploy",
        action="store_true",
        help="Skip docker compose deploy of orangescrum-app",
    )
    parser.add_argument(
        "--keep-package",
        action="store_true",
        help="Keep the package directory after build (default is to delete)",
    )

    parser.add_argument(
        "--env-file",
        help="Path to orangescrum-ee env file (defaults to .env or .env.example)",
    )

    # Optional overrides (take precedence over env file)
    parser.add_argument("--app-port", type=int, help="Expose app on this port")
    parser.add_argument(
        "--app-bind-ip", help="Bind app port to this IP (default 0.0.0.0)"
    )

    parser.add_argument("--db-host", help="Database hostname for the app")
    parser.add_argument("--db-port", type=int, help="Database port for the app")
    parser.add_argument("--db-username", help="Database username for the app")
    parser.add_argument("--db-password", help="Database password for the app")
    parser.add_argument("--db-name", help="Database name for the app")

    args = parser.parse_args()

    if args.check:
        raise SystemExit(0 if check_prerequisites() else 1)

    if not check_prerequisites():
        raise SystemExit(1)

    docker_client = docker.from_env()

    env_file = _resolve_env_file(args.env_file)

    env_overrides: dict[str, str] = {}
    if args.app_port is not None:
        env_overrides["APP_PORT"] = str(args.app_port)
    if args.app_bind_ip:
        env_overrides["APP_BIND_IP"] = args.app_bind_ip

    if args.db_host:
        env_overrides["DB_HOST"] = args.db_host
    if args.db_port is not None:
        env_overrides["DB_PORT"] = str(args.db_port)
    if args.db_username:
        env_overrides["DB_USERNAME"] = args.db_username
    if args.db_password:
        env_overrides["DB_PASSWORD"] = args.db_password
    if args.db_name:
        env_overrides["DB_NAME"] = args.db_name

    # Build binary if requested
    if not args.skip_frankenphp:
        if not args.skip_archive:
            _clean_dir(PACKAGE)
            archive_path = _archive_repo()
            _extract_archive(archive_path, PACKAGE)
            archive_path.unlink(missing_ok=True)
            print(f"Package extracted to {PACKAGE}")
            
            # Copy modified config files after extraction
            _copy_config_overrides()

        if not args.skip_base:
            _ensure_base_image(docker_client, rebuild=args.rebuild_base)

        _build_app_embed()
        _start_app_builder_container()
        _copy_frankenphp_binary(docker_client)
        _stop_builder_stack()

        if not args.keep_package and PACKAGE.exists():
            print(f"Cleaning up package directory {PACKAGE}...")
            shutil.rmtree(PACKAGE)

    # Deploy only app
    if not args.skip_deploy:
        _deploy_app_only(env_file=env_file, env_overrides=env_overrides)
        _wait_for_app_healthy(docker_client, env_overrides)

        app_port = int(env_overrides.get("APP_PORT", "8080"))
        print(f"\nApp should be reachable at: http://127.0.0.1:{app_port}")


if __name__ == "__main__":
    main()
