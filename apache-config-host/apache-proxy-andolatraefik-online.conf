# Apache Reverse Proxy Configuration for OrangeScrum Docker (LAN Access)
# Domain: andolatraefik.online (for LAN access)
# Local Domain: andolatraefik.online
# Generated: 2026-02-12 19:43:42
# Traefik HTTPS Port: 10043
#
# This configuration can be installed on ANY Apache server on the LAN
# The Docker setup does NOT need to be on the same machine
#
# Example Scenario:
#   - Docker (Traefik) running on: 192.168.2.132 (ports 10000/10043)
#   - Apache server running on:    [APACHE_SERVER_IP] (ports 80/443) <- This config file
#
# Installation:
#   1. Copy this file to Apache config:
#      sudo cp apache-proxy-andolatraefik-online.conf /etc/apache2/sites-available/orangescrum-andolatraefik-online.conf
#   2. Update TRAEFIK_HOST variable below to point to Docker server IP
#   3. Update SSL certificate paths if needed
#   4. Enable Apache modules:
#      sudo a2enmod proxy proxy_http ssl rewrite headers
#   5. Enable site:
#      sudo a2ensite orangescrum-andolatraefik-online
#   6. Reload Apache:
#      sudo systemctl reload apache2
#
# Client Configuration (on LAN machines):
#   Add to /etc/hosts (Linux/Mac) or C:\Windows\System32\drivers\etc\hosts (Windows):
#   [APACHE_SERVER_IP] v4.andolatraefik.online app.andolatraefik.online selfhosted.andolatraefik.online mail.andolatraefik.online
#   (Replace [APACHE_SERVER_IP] with the IP of the Apache server)

# IMPORTANT: Set this to the IP address where Docker/Traefik is running
# Default is the detected LAN IP, change if Apache is on a different server
Define TRAEFIK_HOST 192.168.2.132
Define TRAEFIK_HTTPS_PORT 10043

<VirtualHost *:80>
    ServerName app.andolatraefik.online
    ServerAlias v4.andolatraefik.online selfhosted.andolatraefik.online mail.andolatraefik.online
    ServerAlias storage.andolatraefik.online console.andolatraefik.online traefik.andolatraefik.online
    ServerAlias *.andolatraefik.online
    
    # Redirect HTTP to HTTPS
    Redirect permanent / https://app.andolatraefik.online/
</VirtualHost>

# Main catch-all proxy for all subdomains
<VirtualHost *:443>
    ServerName app.andolatraefik.online
    ServerAlias *.andolatraefik.online
    
    SSLEngine on
    SSLCertificateFile /workspaces/os-next/certs/andolatraefik.online.crt
    SSLCertificateKeyFile /workspaces/os-next/certs/andolatraefik.online.key
    
    # Proxy to Traefik, but rewrite Host header to andolatraefik.online
    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    SSLProxyCheckPeerExpire off
    
    # Rewrite Host header from andolatraefik.online to andolatraefik.online for Traefik routing
    RequestHeader set Host "%{HTTP_HOST}e"
    RequestHeader edit Host "andolatraefik\.online" "andolatraefik.online"
    
    ProxyPreserveHost Off
    ProxyPass / https://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/
    ProxyPassReverse / https://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/
    
    # Fix response headers
    Header edit Location "andolatraefik\.online" "andolatraefik.online"
    
    # WebSocket support
    RewriteEngine on
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "wss://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/$1" [P,L]
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/orangescrum-andolatraefik-online-error.log
    CustomLog ${APACHE_LOG_DIR}/orangescrum-andolatraefik-online-access.log combined
</VirtualHost>

# Individual VirtualHosts for better logging
<VirtualHost *:443>
    ServerName v4.andolatraefik.online
    
    SSLEngine on
    SSLCertificateFile /workspaces/os-next/certs/andolatraefik.online.crt
    SSLCertificateKeyFile /workspaces/os-next/certs/andolatraefik.online.key
    
    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    
    # Rewrite Host to v4.andolatraefik.online
    RequestHeader set Host "v4.andolatraefik.online"
    
    ProxyPreserveHost Off
    ProxyPass / https://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/
    ProxyPassReverse / https://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/
    
    Header edit Location "andolatraefik\.online" "andolatraefik.online"
    
    RewriteEngine on
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "wss://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/$1" [P,L]
    
    ErrorLog ${APACHE_LOG_DIR}/v4-andolatraefik-online-error.log
    CustomLog ${APACHE_LOG_DIR}/v4-andolatraefik-online-access.log combined
</VirtualHost>

<VirtualHost *:443>
    ServerName selfhosted.andolatraefik.online
    
    SSLEngine on
    SSLCertificateFile /workspaces/os-next/certs/andolatraefik.online.crt
    SSLCertificateKeyFile /workspaces/os-next/certs/andolatraefik.online.key
    
    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    
    # Rewrite Host to selfhosted.andolatraefik.online
    RequestHeader set Host "selfhosted.andolatraefik.online"
    
    ProxyPreserveHost Off
    ProxyPass / https://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/
    ProxyPassReverse / https://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/
    
    Header edit Location "andolatraefik\.online" "andolatraefik.online"
    
    RewriteEngine on
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "wss://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/$1" [P,L]
    
    ErrorLog ${APACHE_LOG_DIR}/selfhosted-andolatraefik-online-error.log
    CustomLog ${APACHE_LOG_DIR}/selfhosted-andolatraefik-online-access.log combined
</VirtualHost>

<VirtualHost *:443>
    ServerName mail.andolatraefik.online
    
    SSLEngine on
    SSLCertificateFile /workspaces/os-next/certs/andolatraefik.online.crt
    SSLCertificateKeyFile /workspaces/os-next/certs/andolatraefik.online.key
    
    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    
    # Rewrite Host to mail.andolatraefik.online
    RequestHeader set Host "mail.andolatraefik.online"
    
    ProxyPreserveHost Off
    ProxyPass / https://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/
    ProxyPassReverse / https://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/
    
    Header edit Location "andolatraefik\.online" "andolatraefik.online"
    
    RewriteEngine on
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "wss://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/$1" [P,L]
    
    ErrorLog ${APACHE_LOG_DIR}/mail-andolatraefik-online-error.log
    CustomLog ${APACHE_LOG_DIR}/mail-andolatraefik-online-access.log combined
</VirtualHost>

<VirtualHost *:443>
    ServerName storage.andolatraefik.online
    
    SSLEngine on
    SSLCertificateFile /workspaces/os-next/certs/andolatraefik.online.crt
    SSLCertificateKeyFile /workspaces/os-next/certs/andolatraefik.online.key
    
    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    
    # Rewrite Host to storage.andolatraefik.online
    RequestHeader set Host "storage.andolatraefik.online"
    
    ProxyPreserveHost Off
    ProxyPass / https://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/
    ProxyPassReverse / https://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/
    
    Header edit Location "andolatraefik\.online" "andolatraefik.online"
    
    RewriteEngine on
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "wss://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/$1" [P,L]
    
    ErrorLog ${APACHE_LOG_DIR}/storage-andolatraefik-online-error.log
    CustomLog ${APACHE_LOG_DIR}/storage-andolatraefik-online-access.log combined
</VirtualHost>

<VirtualHost *:443>
    ServerName console.andolatraefik.online
    
    SSLEngine on
    SSLCertificateFile /workspaces/os-next/certs/andolatraefik.online.crt
    SSLCertificateKeyFile /workspaces/os-next/certs/andolatraefik.online.key
    
    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    
    # Rewrite Host to console.andolatraefik.online
    RequestHeader set Host "console.andolatraefik.online"
    
    ProxyPreserveHost Off
    ProxyPass / https://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/
    ProxyPassReverse / https://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/
    
    Header edit Location "andolatraefik\.online" "andolatraefik.online"
    
    RewriteEngine on
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "wss://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/$1" [P,L]
    
    ErrorLog ${APACHE_LOG_DIR}/console-andolatraefik-online-error.log
    CustomLog ${APACHE_LOG_DIR}/console-andolatraefik-online-access.log combined
</VirtualHost>
