# Apache Reverse Proxy Configuration for OrangeScrum Docker (LAN Access)
# Domain: ossiba.com (for LAN access)
# Local Domain: ossiba.local
# Generated: 2026-02-13 12:04:33
# Traefik HTTPS Port: 18643
#
# This configuration can be installed on ANY Apache server on the LAN
# The Docker setup does NOT need to be on the same machine
#
# Example Scenario:
#   - Docker (Traefik) running on: 192.168.2.132 (ports 18600/18643)
#   - Apache server running on:    [APACHE_SERVER_IP] (ports 80/443) <- This config file
#
# Installation:
#   1. Copy this file to Apache config:
#      sudo cp apache-proxy-ossiba-com.conf /etc/apache2/sites-available/orangescrum-ossiba-com.conf
#   2. Update TRAEFIK_HOST variable below to point to Docker server IP
#   3. Update SSL certificate paths if needed
#   4. Enable Apache modules:
#      sudo a2enmod proxy proxy_http ssl rewrite headers
#   5. Enable site:
#      sudo a2ensite orangescrum-ossiba-com
#   6. Reload Apache:
#      sudo systemctl reload apache2
#
# Client Configuration (on LAN machines):
#   Add to /etc/hosts (Linux/Mac) or C:\Windows\System32\drivers\etc\hosts (Windows):
#   [APACHE_SERVER_IP] v4.ossiba.com app.ossiba.com selfhosted.ossiba.com mail.ossiba.com
#   (Replace [APACHE_SERVER_IP] with the IP of the Apache server)

# IMPORTANT: Set this to the IP address where Docker/Traefik is running
# Default is the detected LAN IP, change if Apache is on a different server
Define TRAEFIK_HOST 192.168.2.132
Define TRAEFIK_HTTPS_PORT 18643

<VirtualHost *:80>
    ServerName app.ossiba.com
    ServerAlias v4.ossiba.com selfhosted.ossiba.com mail.ossiba.com
    ServerAlias storage.ossiba.com console.ossiba.com traefik.ossiba.com
    ServerAlias *.ossiba.com
    
    # Redirect HTTP to HTTPS
    Redirect permanent / https://app.ossiba.com/
</VirtualHost>

# Main catch-all proxy for all subdomains
<VirtualHost *:443>
    ServerName app.ossiba.com
    ServerAlias *.ossiba.com
    
    SSLEngine on
    SSLCertificateFile /workspaces/os-next/certs/ossiba.com.crt
    SSLCertificateKeyFile /workspaces/os-next/certs/ossiba.com.key
    
    # Proxy to Traefik, but rewrite Host header to ossiba.local
    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    SSLProxyCheckPeerExpire off
    
    # Rewrite Host header from ossiba.com to ossiba.local for Traefik routing
    RequestHeader set Host "%{HTTP_HOST}e"
    RequestHeader edit Host "ossiba\.com" "ossiba.local"
    
    ProxyPreserveHost Off
    ProxyPass / https://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/
    ProxyPassReverse / https://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/
    
    # Fix response headers
    Header edit Location "ossiba\.local" "ossiba.com"
    
    # WebSocket support
    RewriteEngine on
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "wss://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/$1" [P,L]
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/orangescrum-ossiba-com-error.log
    CustomLog ${APACHE_LOG_DIR}/orangescrum-ossiba-com-access.log combined
</VirtualHost>

# Individual VirtualHosts for better logging
<VirtualHost *:443>
    ServerName v4.ossiba.com
    
    SSLEngine on
    SSLCertificateFile /workspaces/os-next/certs/ossiba.com.crt
    SSLCertificateKeyFile /workspaces/os-next/certs/ossiba.com.key
    
    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    
    # Rewrite Host to v4.ossiba.local
    RequestHeader set Host "v4.ossiba.local"
    
    ProxyPreserveHost Off
    ProxyPass / https://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/
    ProxyPassReverse / https://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/
    
    Header edit Location "ossiba\.local" "ossiba.com"
    
    RewriteEngine on
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "wss://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/$1" [P,L]
    
    ErrorLog ${APACHE_LOG_DIR}/v4-ossiba-com-error.log
    CustomLog ${APACHE_LOG_DIR}/v4-ossiba-com-access.log combined
</VirtualHost>

<VirtualHost *:443>
    ServerName selfhosted.ossiba.com
    
    SSLEngine on
    SSLCertificateFile /workspaces/os-next/certs/ossiba.com.crt
    SSLCertificateKeyFile /workspaces/os-next/certs/ossiba.com.key
    
    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    
    # Rewrite Host to selfhosted.ossiba.local
    RequestHeader set Host "selfhosted.ossiba.local"
    
    ProxyPreserveHost Off
    ProxyPass / https://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/
    ProxyPassReverse / https://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/
    
    Header edit Location "ossiba\.local" "ossiba.com"
    
    RewriteEngine on
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "wss://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/$1" [P,L]
    
    ErrorLog ${APACHE_LOG_DIR}/selfhosted-ossiba-com-error.log
    CustomLog ${APACHE_LOG_DIR}/selfhosted-ossiba-com-access.log combined
</VirtualHost>

<VirtualHost *:443>
    ServerName mail.ossiba.com
    
    SSLEngine on
    SSLCertificateFile /workspaces/os-next/certs/ossiba.com.crt
    SSLCertificateKeyFile /workspaces/os-next/certs/ossiba.com.key
    
    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    
    # Rewrite Host to mail.ossiba.local
    RequestHeader set Host "mail.ossiba.local"
    
    ProxyPreserveHost Off
    ProxyPass / https://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/
    ProxyPassReverse / https://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/
    
    Header edit Location "ossiba\.local" "ossiba.com"
    
    RewriteEngine on
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "wss://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/$1" [P,L]
    
    ErrorLog ${APACHE_LOG_DIR}/mail-ossiba-com-error.log
    CustomLog ${APACHE_LOG_DIR}/mail-ossiba-com-access.log combined
</VirtualHost>

<VirtualHost *:443>
    ServerName storage.ossiba.com
    
    SSLEngine on
    SSLCertificateFile /workspaces/os-next/certs/ossiba.com.crt
    SSLCertificateKeyFile /workspaces/os-next/certs/ossiba.com.key
    
    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    
    # Rewrite Host to storage.ossiba.local
    RequestHeader set Host "storage.ossiba.local"
    
    ProxyPreserveHost Off
    ProxyPass / https://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/
    ProxyPassReverse / https://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/
    
    Header edit Location "ossiba\.local" "ossiba.com"
    
    RewriteEngine on
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "wss://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/$1" [P,L]
    
    ErrorLog ${APACHE_LOG_DIR}/storage-ossiba-com-error.log
    CustomLog ${APACHE_LOG_DIR}/storage-ossiba-com-access.log combined
</VirtualHost>

<VirtualHost *:443>
    ServerName console.ossiba.com
    
    SSLEngine on
    SSLCertificateFile /workspaces/os-next/certs/ossiba.com.crt
    SSLCertificateKeyFile /workspaces/os-next/certs/ossiba.com.key
    
    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    
    # Rewrite Host to console.ossiba.local
    RequestHeader set Host "console.ossiba.local"
    
    ProxyPreserveHost Off
    ProxyPass / https://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/
    ProxyPassReverse / https://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/
    
    Header edit Location "ossiba\.local" "ossiba.com"
    
    RewriteEngine on
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "wss://${TRAEFIK_HOST}:${TRAEFIK_HTTPS_PORT}/$1" [P,L]
    
    ErrorLog ${APACHE_LOG_DIR}/console-ossiba-com-error.log
    CustomLog ${APACHE_LOG_DIR}/console-ossiba-com-access.log combined
</VirtualHost>
