# Apache Virtual Host Configuration for ossiba.online
# Host Machine: 192.168.2.132
# VM with Traefik: 192.168.49.10
# Last Updated: 2026-01-06

# IMPORTANT: v4 subdomain MUST come before wildcard to prevent conflicts

# =============================================================================
# Durango V4 - v4.ossiba.online (HTTPS)
# =============================================================================
<VirtualHost *:443>
    ServerName v4.ossiba.online
    ServerAdmin support@orangescrum.com

    # SSL Configuration
    SSLEngine On
    SSLCertificateFile /etc/ssl/certs/apache-selfsigned.crt
    SSLCertificateKeyFile /etc/ssl/private/apache-selfsigned.key

    # Security Headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always append X-Frame-Options SAMEORIGIN

    # Proxy Configuration to VM Traefik
    SSLProxyEngine On
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    
    ProxyPreserveHost On
    ProxyPass / https://192.168.49.10/
    ProxyPassReverse / https://192.168.49.10/

    # Forward protocol headers
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-SSL "on"
    RequestHeader set X-Forwarded-Host "v4.ossiba.online"

    # Cookie domain fix for cross-subdomain sessions
    ProxyPassReverseCookieDomain 192.168.49.10 v4.ossiba.online

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/ossiba-online-v4-error.log
    CustomLog ${APACHE_LOG_DIR}/ossiba-online-v4-access.log combined
    
    # Optional: Log load test requests separately
    # SetEnvIf X-Load-Test-Token ".+" load_test
    # CustomLog ${APACHE_LOG_DIR}/ossiba-online-v4-loadtest.log combined env=load_test
</VirtualHost>

# =============================================================================
# Orangescrum V2 - ossiba.online and wildcards (HTTPS)
# This MUST come AFTER v4.ossiba.online to prevent wildcard from intercepting
# =============================================================================
<VirtualHost *:443>
    ServerName ossiba.online
    ServerAlias www.ossiba.online *.ossiba.online
    ServerAdmin support@orangescrum.com

    # SSL Configuration
    SSLEngine On
    SSLCertificateFile /etc/ssl/certs/apache-selfsigned.crt
    SSLCertificateKeyFile /etc/ssl/private/apache-selfsigned.key

    # Security Headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always append X-Frame-Options SAMEORIGIN

    # Proxy Configuration to VM Traefik
    SSLProxyEngine On
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    
    ProxyPreserveHost On
    ProxyPass / https://192.168.49.10/
    ProxyPassReverse / https://192.168.49.10/

    # Forward protocol headers
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-SSL "on"

    # Cookie domain fix for session sharing
    ProxyPassReverseCookieDomain 192.168.49.10 .ossiba.online

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/ossiba-online-v2-error.log
    CustomLog ${APACHE_LOG_DIR}/ossiba-online-v2-access.log combined
</VirtualHost>

# =============================================================================
# HTTP to HTTPS Redirect (Port 80)
# =============================================================================
<VirtualHost *:80>
    ServerName ossiba.online
    ServerAlias www.ossiba.online v4.ossiba.online *.ossiba.online

    # Redirect all HTTP traffic to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]

    ErrorLog ${APACHE_LOG_DIR}/ossiba-online-redirect-error.log
    CustomLog ${APACHE_LOG_DIR}/ossiba-online-redirect-access.log combined
</VirtualHost>
