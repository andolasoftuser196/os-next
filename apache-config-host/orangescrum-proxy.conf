<VirtualHost *:80>
    ServerName app.ossiba.local
    ServerAlias v4.ossiba.local selfhosted.ossiba.local mail.ossiba.local
    ServerAlias storage.ossiba.local console.ossiba.local traefik.ossiba.local
    ServerAlias *.ossiba.local
    
    # Redirect HTTP to HTTPS
    Redirect permanent / https://app.ossiba.local/
</VirtualHost>

<VirtualHost *:443>
    ServerName app.ossiba.local
    ServerAlias *.ossiba.local
    
    SSLEngine on
    SSLCertificateFile /workspaces/os-next/certs/ossiba.local.crt
    SSLCertificateKeyFile /workspaces/os-next/certs/ossiba.local.key
    
    # Proxy all requests to Traefik on port 8443
    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    SSLProxyCheckPeerExpire off
    
    ProxyPreserveHost On
    ProxyPass / https://127.0.0.1:8443/
    ProxyPassReverse / https://127.0.0.1:8443/
    
    # WebSocket support
    RewriteEngine on
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "wss://127.0.0.1:8443/$1" [P,L]
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/orangescrum-proxy-error.log
    CustomLog ${APACHE_LOG_DIR}/orangescrum-proxy-access.log combined
</VirtualHost>

# Alternative: Separate VirtualHost for each subdomain
<VirtualHost *:443>
    ServerName v4.ossiba.local
    
    SSLEngine on
    SSLCertificateFile /workspaces/os-next/certs/ossiba.local.crt
    SSLCertificateKeyFile /workspaces/os-next/certs/ossiba.local.key
    
    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    
    ProxyPreserveHost On
    ProxyPass / https://127.0.0.1:8443/
    ProxyPassReverse / https://127.0.0.1:8443/
    
    ErrorLog ${APACHE_LOG_DIR}/v4-proxy-error.log
    CustomLog ${APACHE_LOG_DIR}/v4-proxy-access.log combined
</VirtualHost>

<VirtualHost *:443>
    ServerName selfhosted.ossiba.local
    
    SSLEngine on
    SSLCertificateFile /workspaces/os-next/certs/ossiba.local.crt
    SSLCertificateKeyFile /workspaces/os-next/certs/ossiba.local.key
    
    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    
    ProxyPreserveHost On
    ProxyPass / https://127.0.0.1:8443/
    ProxyPassReverse / https://127.0.0.1:8443/
    
    ErrorLog ${APACHE_LOG_DIR}/selfhosted-proxy-error.log
    CustomLog ${APACHE_LOG_DIR}/selfhosted-proxy-access.log combined
</VirtualHost>

<VirtualHost *:443>
    ServerName mail.ossiba.local
    
    SSLEngine on
    SSLCertificateFile /workspaces/os-next/certs/ossiba.local.crt
    SSLCertificateKeyFile /workspaces/os-next/certs/ossiba.local.key
    
    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    
    ProxyPreserveHost On
    ProxyPass / https://127.0.0.1:8443/
    ProxyPassReverse / https://127.0.0.1:8443/
    
    ErrorLog ${APACHE_LOG_DIR}/mail-proxy-error.log
    CustomLog ${APACHE_LOG_DIR}/mail-proxy-access.log combined
</VirtualHost>

<VirtualHost *:443>
    ServerName storage.ossiba.local
    
    SSLEngine on
    SSLCertificateFile /workspaces/os-next/certs/ossiba.local.crt
    SSLCertificateKeyFile /workspaces/os-next/certs/ossiba.local.key
    
    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    
    ProxyPreserveHost On
    ProxyPass / https://127.0.0.1:8443/
    ProxyPassReverse / https://127.0.0.1:8443/
    
    ErrorLog ${APACHE_LOG_DIR}/storage-proxy-error.log
    CustomLog ${APACHE_LOG_DIR}/storage-proxy-access.log combined
</VirtualHost>

<VirtualHost *:443>
    ServerName console.ossiba.local
    
    SSLEngine on
    SSLCertificateFile /workspaces/os-next/certs/ossiba.local.crt
    SSLCertificateKeyFile /workspaces/os-next/certs/ossiba.local.key
    
    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    
    ProxyPreserveHost On
    ProxyPass / https://127.0.0.1:8443/
    ProxyPassReverse / https://127.0.0.1:8443/
    
    ErrorLog ${APACHE_LOG_DIR}/console-proxy-error.log
    CustomLog ${APACHE_LOG_DIR}/console-proxy-access.log combined
</VirtualHost>

<VirtualHost *:443>
    ServerName traefik.ossiba.local
    
    SSLEngine on
    SSLCertificateFile /workspaces/os-next/certs/ossiba.local.crt
    SSLCertificateKeyFile /workspaces/os-next/certs/ossiba.local.key
    
    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    
    ProxyPreserveHost On
    ProxyPass / https://127.0.0.1:8443/
    ProxyPassReverse / https://127.0.0.1:8443/
    
    ErrorLog ${APACHE_LOG_DIR}/traefik-proxy-error.log
    CustomLog ${APACHE_LOG_DIR}/traefik-proxy-access.log combined
</VirtualHost>
